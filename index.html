<!doctype html>
<html>
<head>
    <title>信任的进化</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="an interactive guide to the game theory of why &amp; how we trust each other">

    <!-- 内联关键CSS以避免加载阻塞 -->
    <style>
        /* 基础样式 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            z-index: 9999;
            font-size: 18px;
        }
        
        #main {
            display: none;
            width: 100%;
            max-width: 100%;
        }
        
        #slideshow_container {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        
        /* 加载动画 */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 改进的预加载界面 -->
    <div id="preloader">
        <div class="loader"></div>
        <div>加载中...</div>
        <div id="load-progress" style="margin-top: 10px; font-size: 14px;"></div>
    </div>
    
    <!-- 主内容区域 -->
    <div id="main">
        <div id="slideshow_container">
            <div id="slideshow"></div>
            <div id="scratcher"></div>
        </div>
    </div>
    
    <!-- 页脚 -->
    <div id="footer" style="display:none">
        <div id="sound" sound="on" class="no-select">
            <div id="sound_icon"></div>
            <div id="sound_on">开</div>
            <div id="sound_off">关</div>
        </div>
        <div id="select"></div>

        <sharing title="信用的进化"
                 text="人们不再彼此相互信任，为什么？我们该怎么改变这种情况？一个合作博弈论的互动讲解手册："
                 link="https://trust.csy2022.top/">
        </sharing>
    </div>

    <!-- 使用资源加载监控脚本 -->
    <script>
        // 资源加载监控
        const resources = [
            'css/slides.css',
            'css/balloon.css',
            'js/lib/helpers.js',
            'js/lib/pegasus.js',
            'js/lib/minpubsub.src.js',
            'js/lib/pixi.min.js',
            'js/lib/howler.js',
            'js/lib/tweenjs-0.6.2.min.js',
            'js/lib/sharing.js',
            'js/core/Loader.js',
            'js/core/Slideshow.js',
            'js/core/SlideSelect.js',
            'js/core/Button.js',
            'js/core/TextBox.js',
            'js/core/Words.js',
            'js/main.js'
        ];
        
        let loadedCount = 0;
        const progressElement = document.getElementById('load-progress');
        
        function updateProgress() {
            loadedCount++;
            const progress = Math.round((loadedCount / resources.length) * 100);
            progressElement.textContent = `已加载 ${progress}%`;
            
            if (loadedCount === resources.length) {
                // 所有资源加载完成
                setTimeout(() => {
                    document.getElementById('preloader').style.display = 'none';
                    document.getElementById('main').style.display = 'block';
                    document.getElementById('footer').style.display = 'flex';
                    
                    // 初始化主应用
                    if (typeof initApp === 'function') {
                        initApp();
                    }
                }, 500);
            }
        }
        
        // 动态加载资源
        resources.forEach(resource => {
            const isCSS = resource.endsWith('.css');
            const element = isCSS 
                ? document.createElement('link')
                : document.createElement('script');
            
            if (isCSS) {
                element.rel = 'stylesheet';
                element.href = resource + '?v=' + Date.now();
            } else {
                element.src = resource + '?v=' + Date.now();
            }
            
            element.onload = updateProgress;
            element.onerror = function() {
                console.error('Failed to load resource:', resource);
                updateProgress(); // 即使失败也继续
            };
            
            document.head.appendChild(element);
        });
        
        // 超时处理
        setTimeout(() => {
            if (loadedCount < resources.length) {
                progressElement.textContent += ' (网络较慢，请耐心等待...)';
            }
        }, 5000);
        
        // 极端情况处理
        setTimeout(() => {
            if (loadedCount < resources.length) {
                progressElement.textContent = '加载遇到问题，尝试刷新页面';
                document.getElementById('preloader').innerHTML += 
                    '<div style="margin-top:20px;"><button onclick="window.location.reload()">刷新页面</button></div>';
            }
        }, 15000);
    </script>
</body>
</html>